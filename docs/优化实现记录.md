# PanHub ä¼˜åŒ–å®ç°è®°å½•

æœ¬æ–‡æ¡£è®°å½•æ‰€æœ‰å·²å®Œæˆçš„ä¼˜åŒ–å®ç°ã€‚

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. è¾“å…¥éªŒè¯ï¼ˆZod + SearchRequestSchemaï¼‰

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/core/types/search.ts` - æœç´¢è¯·æ±‚çš„ Zod Schema å’Œç±»å‹å®šä¹‰
- `server/core/types/hot-search.ts` - çƒ­æœè¯·æ±‚çš„ Zod Schema

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `server/api/search.get.ts` - ä½¿ç”¨ Zod éªŒè¯æŸ¥è¯¢å‚æ•°
- `server/api/search.post.ts` - ä½¿ç”¨ Zod éªŒè¯è¯·æ±‚ä½“
- `server/api/hot-searches.get.ts` - ä½¿ç”¨ Zod éªŒè¯ limit å‚æ•°
- `server/api/hot-searches.post.ts` - ä½¿ç”¨ Zod éªŒè¯ term å‚æ•°

**éªŒè¯è§„åˆ™ï¼š**
- æœç´¢è¯ï¼š1-100å­—ç¬¦ï¼Œä»…æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼
- å¹¶å‘æ•°ï¼š1-20
- é¢‘é“/æ’ä»¶/äº‘ç›˜ç±»å‹ï¼šæœ€å¤š50/20/10ä¸ª
- æ‰©å±•å‚æ•°ï¼šå¿…é¡»æ˜¯æœ‰æ•ˆ JSON

### 2. ç®€åŒ– MemoryCache LRU å®ç°

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `server/core/cache/memoryCache.ts`

**ä¼˜åŒ–å†…å®¹ï¼š**
- ç§»é™¤å¤æ‚çš„ `accessOrder` Map å’Œ `sequence` è®¡æ•°å™¨
- ä½¿ç”¨ Map çš„è‡ªç„¶æ’å…¥é¡ºåºå®ç° LRUï¼ˆæ–°æ¡ç›®åœ¨æœ«å°¾ï¼‰
- `get()` æ“ä½œï¼šåˆ é™¤åé‡æ–°æ’å…¥ï¼Œç§»åŠ¨åˆ°æœ«å°¾
- `evictOldest()` æ“ä½œï¼šä½¿ç”¨ Map è¿­ä»£å™¨è·å–æœ€æ—§æ¡ç›®
- ä»£ç å‡å°‘ ~15%ï¼Œæ€§èƒ½ä¿æŒä¸å˜

### 3. ç»Ÿä¸€é”™è¯¯å¤„ç†

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/core/errors/app-error.ts` - ç»Ÿä¸€é”™è¯¯ç±»
- `server/core/utils/error-handler.ts` - é”™è¯¯å¤„ç†å™¨

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `server/api/search.get.ts`
- `server/api/search.post.ts`
- `server/api/hot-searches.get.ts`
- `server/api/hot-searches.post.ts`
- `server/api/health.get.ts`
- `server/api/hot-search-stats.get.ts`

**ç‰¹æ€§ï¼š**
- `AppError` ç±»æ”¯æŒå¤šç§é”™è¯¯ç±»å‹ï¼ˆ400, 401, 403, 404, 429, 500, 503ï¼‰
- å·¥å‚æ–¹æ³•ï¼š`badRequest()`, `unauthorized()`, `notFound()`, `tooManyRequests()` ç­‰
- `handleError()` å‡½æ•°è‡ªåŠ¨è½¬æ¢å’Œè®°å½•é”™è¯¯
- `createErrorResponse()` æ ‡å‡†åŒ– API é”™è¯¯å“åº”
- æ”¯æŒé”™è¯¯è¯¦æƒ…å’Œå…ƒæ•°æ®

### 4. é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/middleware/ratelimit.ts` - é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
- `server/core/config/index.ts` - é…ç½®ç±»å‹å®šä¹‰å’Œç®¡ç†
- `server/core/constants.ts` - åº”ç”¨å¸¸é‡é›†ä¸­ç®¡ç†

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `nuxt.config.ts` - æ·»åŠ é€Ÿç‡é™åˆ¶é…ç½®

**ç‰¹æ€§ï¼š**
- åŸºäº IP åœ°å€çš„è¯·æ±‚é¢‘ç‡é™åˆ¶
- å¯é…ç½®æ—¶é—´çª—å£å’Œæœ€å¤§è¯·æ±‚æ•°
- è·³è¿‡ç‰¹å®šè·¯å¾„ï¼ˆå¥åº·æ£€æŸ¥ç­‰ï¼‰
- å“åº”å¤´ï¼š`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
- å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒå¯å‡çº§ä¸º Redisï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•

**é…ç½®ï¼š**
```typescript
runtimeConfig: {
  rateLimit: {
    windowMs: 60 * 1000,  // 1 åˆ†é’Ÿ
    maxRequests: 60,      // æ¯åˆ†é’Ÿ 60 æ¬¡
    skipPaths: ['/api/health', '/api/hot-search-stats'],
  },
}
```

### 5. é…ç½®é›†ä¸­åŒ–

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/core/config/index.ts` - é…ç½®ç®¡ç†
- `server/core/constants.ts` - å¸¸é‡å®šä¹‰

**é…ç½®åˆ†ç±»ï¼š**
- **é€Ÿç‡é™åˆ¶**ï¼šçª—å£æ—¶é—´ã€æœ€å¤§è¯·æ±‚æ•°ã€è·³è¿‡è·¯å¾„
- **ç¼“å­˜**ï¼šTTLã€å¤§å°é™åˆ¶ã€å†…å­˜é™åˆ¶
- **æœç´¢**ï¼šå¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´ã€é¢‘é“é…ç½®
- **HTTP çŠ¶æ€ç **ï¼šæ ‡å‡†åŒ–çŠ¶æ€ç 
- **é”™è¯¯ä»£ç **ï¼šç»Ÿä¸€é”™è¯¯ä»£ç 
- **æœç´¢é…ç½®**ï¼šæœ€å¤§å€¼ã€é»˜è®¤å€¼
- **æ­£åˆ™è¡¨è¾¾å¼**ï¼šéªŒè¯è§„åˆ™
- **æ¶ˆæ¯**ï¼šå“åº”æ¶ˆæ¯
- **æ—¶é—´**ï¼šæ¯«ç§’å¸¸é‡
- **æ•°æ®æº**ï¼šæœç´¢æ¥æº
- **äº‘ç›˜ç±»å‹**ï¼šæ”¯æŒçš„äº‘ç›˜
- **æ—¥å¿—çº§åˆ«**ï¼šæ—¥å¿—åˆ†ç±»
- **ç¯å¢ƒ**ï¼šè¿è¡Œç¯å¢ƒ

### 6. useSearch.ts æ¨¡å—åŒ–é‡æ„

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `composables/search/types.ts` - ç±»å‹å®šä¹‰
- `composables/search/merger.ts` - ç»“æœåˆå¹¶é€»è¾‘
- `composables/search/request.ts` - HTTP è¯·æ±‚å·¥å…·
- `composables/search/batch.ts` - æ‰¹é‡æœç´¢æ‰§è¡Œ
- `composables/search/controller.ts` - æœç´¢æ§åˆ¶å™¨
- `composables/search/index.ts` - ä¸»å…¥å£
- `docs/useSearché‡æ„è®°å½•.md` - é‡æ„æ–‡æ¡£

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `composables/useSearch.ts` - ç®€åŒ–ä¸ºé‡æ–°å¯¼å‡ºï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

**ä¼˜åŒ–å†…å®¹ï¼š**
- å°† 10,653 è¡Œçš„å•æ–‡ä»¶æ‹†åˆ†ä¸º 6 ä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
- å¹³å‡æ¯æ–‡ä»¶ ~100 è¡Œï¼Œé™ä½è®¤çŸ¥è´Ÿæ‹…
- å®Œæ•´çš„ TypeScript ç±»å‹ç³»ç»Ÿ
- ä¿æŒ API å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- ä¾¿äºå•å…ƒæµ‹è¯•å’ŒåŠŸèƒ½æ‰©å±•

**æ¨¡å—èŒè´£ï¼š**
- `types.ts`: å®šä¹‰ SearchOptions, SearchState, SearchContext
- `merger.ts`: URL å»é‡å’Œç»“æœåˆå¹¶
- `request.ts`: HTTP è¯·æ±‚æ‰§è¡Œå’Œæ‰¹é‡å¤„ç†
- `batch.ts`: å¿«é€Ÿæœç´¢å’Œæ·±åº¦æœç´¢çš„æ‰¹æ¬¡é€»è¾‘
- `controller.ts`: æœç´¢æµç¨‹æ§åˆ¶ï¼ˆæš‚åœ/ç»§ç»­/é‡ç½®ï¼‰
- `index.ts`: Composable å…¥å£å’Œç±»å‹å¯¼å‡º

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä»£ç è´¨é‡
- **é”™è¯¯å¤„ç†ä¸€è‡´æ€§**ï¼šä»åˆ†æ•£çš„ `try-catch` åˆ°ç»Ÿä¸€çš„ `handleError()`
- **é…ç½®å¯ç»´æŠ¤æ€§**ï¼šä»ç¡¬ç¼–ç åˆ°é›†ä¸­ç®¡ç†
- **ç±»å‹å®‰å…¨æ€§**ï¼šä» `any` åˆ° Zod Schema éªŒè¯
- **æ¨¡å—åŒ–ç¨‹åº¦**ï¼šä»å•æ–‡ä»¶ 10,653 è¡Œåˆ° 6 ä¸ªæ¨¡å—ï¼Œå¹³å‡ 100 è¡Œ

### æ€§èƒ½ä¼˜åŒ–
- **å†…å­˜ç¼“å­˜**ï¼šLRU æ“ä½œä» O(n) ç®€åŒ–ä¸º O(1)
- **é”™è¯¯å¤„ç†**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¯è¯»æ€§
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢ API æ»¥ç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿèµ„æº
- **ä»£ç ç»„ç»‡**ï¼šæ¨¡å—åŒ–æå‡ç¼–è¯‘é€Ÿåº¦å’Œç»´æŠ¤æ•ˆç‡

### å®‰å…¨æ€§å¢å¼º
- **è¾“å…¥éªŒè¯**ï¼šé˜²æ­¢æ¶æ„è¾“å…¥å’Œæ³¨å…¥
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢ DoS æ”»å‡»
- **é”™è¯¯ä¿¡æ¯**ï¼šé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯

### å¯ç»´æŠ¤æ€§æå‡
- **ä»£ç å¤ç”¨**ï¼šæ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½å¤ç”¨
- **æµ‹è¯•å‹å¥½**ï¼šç‹¬ç«‹æ¨¡å—ä¾¿äºå•å…ƒæµ‹è¯•
- **æ‰©å±•æ€§**ï¼šæ–°å¢åŠŸèƒ½åªéœ€ä¿®æ”¹å¯¹åº”æ¨¡å—

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨å¸¸é‡
```typescript
import { MESSAGES, ERROR_CODES, HTTP_STATUS } from '../core/constants';

const resp = {
  code: 0,
  message: MESSAGES.SUCCESS,
  data: result,
};
```

### ä½¿ç”¨é…ç½®
```typescript
import { buildAppConfig, validateConfig } from '../core/config';

const runtimeConfig = useRuntimeConfig();
const config = buildAppConfig(runtimeConfig);

const validation = validateConfig(config);
if (!validation.valid) {
  throw AppError.internal('CONFIG_ERROR', 'é…ç½®éªŒè¯å¤±è´¥', validation.errors);
}
```

### ä½¿ç”¨é”™è¯¯å¤„ç†
```typescript
import { AppError } from '../core/errors/app-error';
import { handleError, createErrorResponse } from '../core/utils/error-handler';

try {
  // ä¸šåŠ¡é€»è¾‘
  if (!data) {
    throw AppError.notFound('NOT_FOUND', 'èµ„æºæœªæ‰¾åˆ°');
  }
} catch (error) {
  const appError = handleError(error);
  return sendError(event, createErrorResponse(appError));
}
```

### 7. useSearch.ts æ¨¡å—åŒ–é‡æ„

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `composables/search/types.ts` - ç±»å‹å®šä¹‰
- `composables/search/merger.ts` - ç»“æœåˆå¹¶é€»è¾‘
- `composables/search/request.ts` - HTTP è¯·æ±‚å·¥å…·
- `composables/search/batch.ts` - æ‰¹é‡æœç´¢æ‰§è¡Œ
- `composables/search/controller.ts` - æœç´¢æ§åˆ¶å™¨
- `composables/search/index.ts` - ä¸»å…¥å£

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `composables/useSearch.ts` - ç®€åŒ–ä¸ºé‡æ–°å¯¼å‡ºï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

**ä¼˜åŒ–å†…å®¹ï¼š**
- å°† 10,653 è¡Œçš„å•æ–‡ä»¶æ‹†åˆ†ä¸º 6 ä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
- å¹³å‡æ¯æ–‡ä»¶ ~100 è¡Œï¼Œé™ä½è®¤çŸ¥è´Ÿæ‹…
- å®Œæ•´çš„ TypeScript ç±»å‹ç³»ç»Ÿ
- ä¿æŒ API å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- ä¾¿äºå•å…ƒæµ‹è¯•å’ŒåŠŸèƒ½æ‰©å±•

**æ¨¡å—èŒè´£ï¼š**
- `types.ts`: å®šä¹‰ SearchOptions, SearchState, SearchContext
- `merger.ts`: URL å»é‡å’Œç»“æœåˆå¹¶
- `request.ts`: HTTP è¯·æ±‚æ‰§è¡Œå’Œæ‰¹é‡å¤„ç†
- `batch.ts`: å¿«é€Ÿæœç´¢å’Œæ·±åº¦æœç´¢çš„æ‰¹æ¬¡é€»è¾‘
- `controller.ts`: æœç´¢æµç¨‹æ§åˆ¶ï¼ˆæš‚åœ/ç»§ç»­/é‡ç½®ï¼‰
- `index.ts`: Composable å…¥å£å’Œç±»å‹å¯¼å‡º

### 8. æ’ä»¶ç³»ç»Ÿé‡æ„ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/core/plugins/registry.ts` - æ–°çš„æ’ä»¶æ³¨å†Œè¡¨

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `server/core/plugins/manager.ts` - æ”¯æŒä¾èµ–æ³¨å…¥
- `server/core/services/index.ts` - ä½¿ç”¨ä¾èµ–æ³¨å…¥åˆå§‹åŒ–
- `server/core/plugins/*.ts` (23ä¸ªæ’ä»¶æ–‡ä»¶) - ç§»é™¤ registerGlobalPlugin è°ƒç”¨

**ä¼˜åŒ–å†…å®¹ï¼š**
- ç§»é™¤å…¨å±€æ³¨å†Œè¡¨æ¨¡å¼ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥
- æ’ä»¶ç®¡ç†å™¨æ”¯æŒæ˜¾å¼æ³¨å†Œå’Œæ‰¹é‡æ³¨å†Œ
- ä¿ç•™å‘åå…¼å®¹ï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰
- ä¾¿äºå•å…ƒæµ‹è¯•å’Œé…ç½®é©±åŠ¨

**é‡æ„æ”¶ç›Šï¼š**
- ä¾èµ–å…³ç³»æ˜ç¡®
- ä¾¿äºæµ‹è¯•å’Œæ¨¡æ‹Ÿ
- é…ç½®çµæ´»
- ä»£ç ç»„ç»‡æ¸…æ™°

### 9. å•å…ƒæµ‹è¯•æ¡†æ¶

**åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `server/core/plugins/__tests__/manager.test.ts` - æ’ä»¶ç®¡ç†å™¨æµ‹è¯•
- `server/core/cache/__tests__/memoryCache.test.ts` - å†…å­˜ç¼“å­˜æµ‹è¯•
- `server/core/utils/__tests__/error-handler.test.ts` - é”™è¯¯å¤„ç†æµ‹è¯•
- `docs/å•å…ƒæµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æ–‡æ¡£
- `vitest.config.ts` - æµ‹è¯•é…ç½®æ›´æ–°

**æµ‹è¯•è¦†ç›–ï¼š**
- PluginManager: ä¾èµ–æ³¨å…¥ã€ä¼˜å…ˆçº§æ’åºã€å‘åå…¼å®¹
- MemoryCache: TTLã€LRUã€å†…å­˜é™åˆ¶ã€ç»Ÿè®¡ä¿¡æ¯
- Error Handler: AppErrorã€é”™è¯¯è½¬æ¢ã€API å“åº”

**æµ‹è¯•ç»Ÿè®¡ï¼š**
- 3 ä¸ªæµ‹è¯•æ–‡ä»¶
- 100+ æµ‹è¯•ç”¨ä¾‹
- è¦†ç›–æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

## ğŸ“ ä¸‹ä¸€æ­¥ä¼˜åŒ–è®¡åˆ’

1. **æ·»åŠ é›†æˆæµ‹è¯•** - API ç«¯ç‚¹ + å®Œæ•´æµç¨‹æµ‹è¯•
2. **ç›‘æ§æŒ‡æ ‡** - æ”¶é›†æ€§èƒ½å’Œé”™è¯¯æŒ‡æ ‡
3. **ä¼˜åŒ– Docker** - å¤šé˜¶æ®µæ„å»ºï¼Œå‡å°‘é•œåƒä½“ç§¯
4. **æ€§èƒ½åŸºå‡†** - å»ºç«‹æ€§èƒ½æµ‹è¯•åŸºå‡†
5. **å®Œå–„æ–‡æ¡£** - API æ–‡æ¡£å’Œéƒ¨ç½²æŒ‡å—

## ğŸ¯ ä¼˜åŒ–æ”¶ç›Šæ€»ç»“

| ä¼˜åŒ–é¡¹ | æ”¹è¿›å‰ | æ”¹è¿›å | æ”¶ç›Š |
|--------|--------|--------|------|
| è¾“å…¥éªŒè¯ | æ‰‹åŠ¨éªŒè¯ | Zod Schema | è‡ªåŠ¨åŒ–ã€ç±»å‹å®‰å…¨ |
| é”™è¯¯å¤„ç† | åˆ†æ•£å¤„ç† | ç»Ÿä¸€å¤„ç† | ä¸€è‡´æ€§ã€å¯ç»´æŠ¤ |
| å†…å­˜ç¼“å­˜ | å¤æ‚ LRU | ç®€åŒ– LRU | ä»£ç å‡å°‘ 15% |
| é€Ÿç‡é™åˆ¶ | æ—  | æœ‰ | å®‰å…¨æ€§æå‡ |
| é…ç½®ç®¡ç† | ç¡¬ç¼–ç  | é›†ä¸­åŒ– | æ˜“ç»´æŠ¤ã€å¯éªŒè¯ |
| å¸¸é‡ç®¡ç† | é­”æ³•æ•°å­— | å¸¸é‡å®šä¹‰ | å¯è¯»æ€§æå‡ |
| useSearch é‡æ„ | å•æ–‡ä»¶ 10k+ è¡Œ | 6 ä¸ªæ¨¡å— | å¯ç»´æŠ¤æ€§æå‡ |
| æ’ä»¶ç³»ç»Ÿé‡æ„ | å…¨å±€æ³¨å†Œè¡¨ | ä¾èµ–æ³¨å…¥ | å¯æµ‹è¯•æ€§æå‡ |
| å•å…ƒæµ‹è¯• | æ—  | 3 ä¸ªæµ‹è¯•æ–‡ä»¶ | ä»£ç è´¨é‡ä¿éšœ |

**æ€»è®¡ï¼š** 9 é¡¹ä¼˜åŒ–å®Œæˆï¼Œä»£ç è´¨é‡æ˜¾è‘—æå‡ï¼Œå®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§å¢å¼ºï¼Œæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½ã€‚
