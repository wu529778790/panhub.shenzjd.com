# 单元测试指南

## 测试框架
- **框架**: Vitest
- **版本**: ^2.1.9
- **语言**: TypeScript

## 测试目录结构

```
project/
├── server/
│   ├── core/
│   │   ├── plugins/
│   │   │   ├── __tests__/
│   │   │   │   └── manager.test.ts          # 插件管理器测试
│   │   ├── cache/
│   │   │   ├── __tests__/
│   │   │   │   └── memoryCache.test.ts      # 内存缓存测试
│   │   ├── utils/
│   │   │   ├── __tests__/
│   │   │   │   └── error-handler.test.ts    # 错误处理测试
│   │   ├── services/
│   │   │   ├── __tests__/
│   │   │   │   └── searchService.test.ts    # 搜索服务测试（待创建）
├── composables/
│   ├── search/
│   │   ├── __tests__/
│   │   │   └── controller.test.ts           # 搜索控制器测试（待创建）
├── test/
│   ├── unit/                                 # 传统测试目录
│   └── api/                                  # API 集成测试
```

## 运行测试

### 运行所有测试
```bash
npm test
```

### 运行特定测试文件
```bash
npx vitest run server/core/plugins/__tests__/manager.test.ts
```

### 监听模式
```bash
npm run test:watch
```

### 生成覆盖率报告
```bash
npm run test:coverage
```

## 已完成的单元测试

### 1. 插件管理器测试 (`server/core/plugins/__tests__/manager.test.ts`)
**测试内容**:
- ✅ 依赖注入方式注册插件
- ✅ 批量注册插件
- ✅ 按优先级排序
- ✅ 获取指定插件
- ✅ 清空插件
- ✅ 空插件处理
- ✅ 向后兼容（全局注册表）
- ✅ 插件搜索功能

**运行**:
```bash
npx vitest run server/core/plugins/__tests__/manager.test.ts
```

### 2. 内存缓存测试 (`server/core/cache/__tests__/memoryCache.test.ts`)
**测试内容**:
- ✅ 基本设置和获取
- ✅ TTL 过期机制
- ✅ LRU 淘汰策略
- ✅ get() 操作更新 LRU 顺序
- ✅ 内存限制
- ✅ 统计信息
- ✅ 配置验证

**运行**:
```bash
npx vitest run server/core/cache/__tests__/memoryCache.test.ts
```

### 3. 错误处理测试 (`server/core/utils/__tests__/error-handler.test.ts`)
**测试内容**:
- ✅ AppError 创建和判断
- ✅ 工厂方法
- ✅ 错误转换
- ✅ withErrorHandling 包装器
- ✅ API 响应格式化

**运行**:
```bash
npx vitest run server/core/utils/__tests__/error-handler.test.ts
```

## 测试最佳实践

### 1. 测试命名
```typescript
describe('模块名称', () => {
  it('应该[预期行为]', () => {
    // 测试实现
  });
});
```

### 2. 使用 beforeEach
```typescript
describe('测试套件', () => {
  let cache: MemoryCache<string>;

  beforeEach(() => {
    cache = new MemoryCache<string>();
  });

  afterEach(() => {
    cache.clear();
  });
});
```

### 3. Mock 时间
```typescript
it('应该处理时间相关逻辑', () => {
  vi.useFakeTimers();

  // 测试代码

  vi.useRealTimers();
});
```

### 4. 异步测试
```typescript
it('应该处理异步操作', async () => {
  const result = await asyncOperation();
  expect(result).toBe(expected);
});
```

## 测试覆盖率目标

| 模块 | 目标覆盖率 | 当前状态 |
|------|-----------|---------|
| PluginManager | 90% | ✅ 已完成 |
| MemoryCache | 95% | ✅ 已完成 |
| Error Handler | 90% | ✅ 已完成 |
| SearchService | 85% | ⏳ 待完成 |
| Search Controller | 85% | ⏳ 待完成 |
| API Routes | 80% | ⏳ 待完成 |

## 下一步测试计划

### 待创建的测试文件
1. `server/core/services/__tests__/searchService.test.ts`
2. `composables/search/__tests__/controller.test.ts`
3. `composables/search/__tests__/batch.test.ts`
4. `server/api/__tests__/search.test.ts` (集成测试)
5. `server/api/__tests__/hot-search.test.ts` (集成测试)

### 需要测试的核心功能
- 搜索服务的并发控制
- 搜索流程的暂停/继续/取消
- 输入验证（Zod Schema）
- 速率限制中间件
- 缓存策略
- 错误处理流程

## 常见问题

### Q: 测试时遇到 "ReferenceError: window is not defined"
A: 在 vitest.config.ts 中设置 `environment: "node"` 或 `"jsdom"`

### Q: 如何测试依赖外部 API 的函数？
A: 使用 Mock 或 Vitest 的 `vi.mock()` 功能

### Q: 如何测试私有方法？
A: 通过公共接口测试，或导出用于测试

### Q: 覆盖率报告在哪里？
A: 运行 `npm run test:coverage` 后，在 `coverage/` 目录查看

## 持续集成

在 CI/CD 流程中添加测试步骤：

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install
      - run: npm test
      - run: npm run test:coverage
```

## 总结

单元测试是保证代码质量的重要手段。通过完善的测试覆盖，我们可以：
- ✅ 及早发现 bug
- ✅ 重构时保持信心
- ✅ 文档化代码行为
- ✅ 提升代码可维护性

建议在开发新功能时同步编写测试，保持测试覆盖率在 80% 以上。