# PanHub 集成测试指南

本文档描述如何运行和编写 PanHub 的集成测试。

## 📋 测试概览

### 测试类型

1. **单元测试** (`server/core/**/__tests__/`) - 核心模块的独立测试
2. **API 集成测试** (`test/api.test.mjs`) - 完整的 API 端到端测试
3. **前端测试** (待实现) - Vue 组件和 Composable 测试

### 测试覆盖

| 模块 | 测试文件 | 状态 |
|------|---------|------|
| PluginManager | `server/core/plugins/__tests__/manager.test.ts` | ✅ |
| PluginRegistry | `server/core/plugins/__tests__/registry.test.ts` | ✅ |
| MemoryCache | `server/core/cache/__tests__/memoryCache.test.ts` | ✅ |
| Error Handler | `server/core/utils/__tests__/error-handler.test.ts` | ✅ |
| API 端点 | `test/api.test.mjs` | ✅ |

## 🚀 运行测试

### 运行所有单元测试

```bash
# 运行所有测试
npm test

# 监听模式
npm run test:watch

# 生成覆盖率报告
npm run test:coverage
```

### 运行特定测试

```bash
# 插件管理器测试
npx vitest run server/core/plugins/__tests__/manager.test.ts

# 插件注册表测试
npx vitest run server/core/plugins/__tests__/registry.test.ts

# 内存缓存测试
npx vitest run server/core/cache/__tests__/memoryCache.test.ts

# 错误处理测试
npx vitest run server/core/utils/__tests__/error-handler.test.ts
```

### 运行 API 集成测试

```bash
# 1. 启动开发服务器
npm run dev

# 2. 在另一个终端运行 API 测试
npm run test:api

# 或者指定 API 地址
API_BASE=http://localhost:3000/api node ./test/api.test.mjs

# 测试特定关键词
KW=测试 npm run test:api

# 测试特定插件
PLUGINS=pansearch,labi npm run test:api
```

## 📝 测试用例详解

### 1. 插件管理器测试

**测试内容：**
- 依赖注入方式注册插件
- 批量注册插件
- 按优先级排序
- 获取指定插件
- 清空插件列表
- 空值处理

**示例：**
```typescript
describe('PluginManager', () => {
  it('应该正确注册单个插件', () => {
    const pm = new PluginManager();
    const plugin = new TestPlugin('test1', 1);
    pm.registerPlugin(plugin);

    expect(pm.size).toBe(1);
    expect(pm.getPlugin('test1')).toBe(plugin);
  });
});
```

### 2. 插件注册表测试

**测试内容：**
- 插件工厂注册
- 批量注册
- 创建单个实例
- 创建所有实例
- 创建指定实例
- 动态配置加载

**示例：**
```typescript
describe('PluginRegistry', () => {
  it('应该正确创建插件实例', () => {
    const registry = new PluginRegistry();
    registry.register('test', () => new TestPlugin('test', 1));

    const instance = registry.create('test');
    expect(instance).toBeInstanceOf(TestPlugin);
    expect(instance?.name()).toBe('test');
  });
});
```

### 3. 内存缓存测试

**测试内容：**
- TTL 过期
- LRU 淘汰
- 内存限制
- 统计信息
- 缓存命中率

**示例：**
```typescript
describe('MemoryCache', () => {
  it('应该正确执行 LRU 淘汰', async () => {
    const cache = new MemoryCache({ maxSize: 2 });

    cache.set('key1', 'value1');
    cache.set('key2', 'value2');
    cache.set('key3', 'value3'); // 应该淘汰 key1

    expect(cache.get('key1')).toBeUndefined();
    expect(cache.get('key2')).toBe('value2');
  });
});
```

### 4. 错误处理测试

**测试内容：**
- AppError 创建和类型判断
- handleError 转换
- withErrorHandling 包装
- createErrorResponse 格式化

**示例：**
```typescript
describe('错误处理工具', () => {
  it('应该正确创建 AppError', () => {
    const error = AppError.badRequest('TEST', '测试');

    expect(error.code).toBe('TEST');
    expect(error.statusCode).toBe(400);
    expect(error.isClientError()).toBe(true);
  });
});
```

### 5. API 集成测试

**测试内容：**

#### 输入验证测试
```javascript
// 缺少参数
GET /search → 400 VALIDATION_ERROR

// 空关键词
GET /search?kw= → 400 VALIDATION_ERROR

// 无效字符
GET /search?kw=<> → 400 VALIDATION_ERROR

// 并发数过大
GET /search?kw=test&concurrency=100 → 400 VALIDATION_ERROR
```

#### 错误响应格式测试
```javascript
// 验证标准错误格式
{
  code: "VALIDATION_ERROR",
  message: "参数验证失败",
  data: null,
  error: {
    statusCode: 400,
    details: [...]
  }
}
```

#### 功能测试
```javascript
// 健康检查
GET /health → { status: "ok", plugin_count: 10, ... }

// 搜索功能
GET /search?kw=test&src=plugin → { code: 0, data: { results: [...] } }

// 热搜功能
GET /hot-searches?limit=5 → { code: 0, data: [...] }
```

## 🔍 测试最佳实践

### 1. 测试命名
使用描述性的中文名称，清楚说明测试目的：
```typescript
it('应该按优先级排序返回插件', () => { ... })
it('应该返回验证错误（并发数过大）', () => { ... })
```

### 2. 测试隔离
每个测试应该独立运行，不依赖其他测试的状态：
```typescript
beforeEach(() => {
  pm = new PluginManager(); // 每个测试前创建新实例
});
```

### 3. 边界测试
测试边界条件和异常情况：
```typescript
// 空值
pm.registerPlugin(null);

// 超出限制
cache.set('key', 'value', { ttl: -1 });

// 无效输入
const result = validate({ kw: '' });
```

### 4. 错误验证
不仅要测试成功路径，还要测试错误路径：
```typescript
try {
  await api.search({ kw: '' });
  // 不应该到达这里
  expect(true).toBe(false);
} catch (e) {
  expect(e.statusCode).toBe(400);
}
```

## 📊 测试覆盖率要求

| 模块 | 语句覆盖率 | 分支覆盖率 | 函数覆盖率 | 行覆盖率 |
|------|-----------|-----------|-----------|---------|
| PluginManager | >90% | >85% | >90% | >90% |
| PluginRegistry | >90% | >85% | >90% | >90% |
| MemoryCache | >90% | >85% | >90% | >90% |
| Error Handler | >90% | >85% | >90% | >90% |
| API Routes | >80% | >75% | >80% | >80% |

## 🛠️ 调试技巧

### 1. 查看详细输出
```bash
npx vitest run --reporter=verbose
```

### 2. 单步调试
```bash
node --inspect-brk node_modules/vitest/vitest.mjs run your-test.ts
```

### 3. 覆盖率报告
```bash
npm run test:coverage
# 查看 coverage/index.html
```

### 4. API 测试调试
```bash
# 添加详细日志
API_BASE=http://localhost:3000/api node ./test/api.test.mjs 2>&1 | tee test.log
```

## 🔧 常见问题

### Q: 测试失败，提示模块未找到
A: 运行 `npm install` 安装依赖

### Q: API 测试全部跳过
A: 确保开发服务器正在运行：`npm run dev`

### Q: 覆盖率报告不准确
A: 清理缓存后重新运行：`rm -rf coverage && npm run test:coverage`

### Q: 某个插件测试总是失败
A: 检查网络连接和目标网站是否可访问

## 📚 相关文档

- [快速参考](./快速参考.md)
- [优化实现记录](./优化实现记录.md)
- [单元测试指南](./单元测试指南.md)
- [未来优化点](./未来优化点.md)
