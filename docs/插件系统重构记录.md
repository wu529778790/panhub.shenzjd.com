# 插件系统重构记录

## 重构时间
2026-01-07

## 重构目标
移除全局注册表模式，使用依赖注入方式管理插件，提高代码的可测试性和可维护性。

## 重构前的问题

### 1. 全局状态管理
```typescript
// 问题：每个插件文件末尾都有 registerGlobalPlugin 调用
// server/core/plugins/pansearch.ts
registerGlobalPlugin(new PansearchPlugin());
```

### 2. 隐式依赖
- 插件在模块加载时自动注册
- 依赖关系不明确
- 难以追踪插件的创建和使用

### 3. 测试困难
- 全局状态使得单元测试复杂
- 需要手动清理注册表
- 难以模拟特定插件配置

### 4. 配置不灵活
- 插件启用/禁用需要修改多个文件
- 硬编码的注册逻辑

## 重构方案

### 1. 创建插件注册表（新文件）
**文件：** `server/core/plugins/registry.ts`

```typescript
export class PluginRegistry {
  private factories: Map<string, PluginFactory> = new Map();

  register(name: string, factory: PluginFactory): void;
  create(name: string): AsyncSearchPlugin | null;
  createAll(): AsyncSearchPlugin[];
  // ... 其他方法
}
```

### 2. 更新插件管理器
**文件：** `server/core/plugins/manager.ts`

```typescript
export class PluginManager {
  private plugins: AsyncSearchPlugin[] = [];

  // 新增：依赖注入方式
  registerPlugin(plugin: AsyncSearchPlugin): void;
  registerPlugins(plugins: AsyncSearchPlugin[]): void;

  // 保留：向后兼容（已标记废弃）
  registerAllGlobalPlugins(): void;

  // 新增：实用方法
  getPlugin(name: string): AsyncSearchPlugin | undefined;
  get size(): number;
  clear(): void;
}
```

### 3. 更新服务初始化
**文件：** `server/core/services/index.ts`

```typescript
function createPluginManager(): PluginManager {
  const pm = new PluginManager();

  // 使用依赖注入方式注册插件
  pm.registerPlugins([
    new HunhepanPlugin(),
    new LabiPlugin(),
    new PantaPlugin(),
    // ... 其他插件
  ]);

  return pm;
}
```

### 4. 清理插件文件
**修改的文件：** 所有23个插件文件

**修改前：**
```typescript
import { BaseAsyncPlugin, registerGlobalPlugin } from "./manager";

export class PansearchPlugin extends BaseAsyncPlugin {
  // ... 插件实现
}

registerGlobalPlugin(new PansearchPlugin());
```

**修改后：**
```typescript
import { BaseAsyncPlugin } from "./manager";

export class PansearchPlugin extends BaseAsyncPlugin {
  // ... 插件实现
}
// 移除 registerGlobalPlugin 调用
```

## 修改的文件清单

### 新增文件
- `server/core/plugins/registry.ts` - 新的插件注册表

### 修改的文件
- `server/core/plugins/manager.ts` - 更新 PluginManager，支持依赖注入
- `server/core/services/index.ts` - 使用依赖注入初始化插件
- `server/core/plugins/zhizhen.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/qupansou.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/susu.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/wanou.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/panta.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/pansearch.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/hdr4k.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/muou.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/ouge.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/pan666.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/fox4k.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/duoduo.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/huban.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/solidtorrents.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/thepiratebay.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/torrentgalaxy.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/x1337x.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/nyaa.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/shandian.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/xuexizhinan.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/panyq.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/labi.ts` - 移除 registerGlobalPlugin
- `server/core/plugins/jikepan.ts` - 移除 registerGlobalPlugin

### 备份文件
- `server/core/plugins/manager.ts.backup` - 原始 manager.ts

## 重构收益

### 1. 依赖关系明确
```typescript
// 现在可以清楚看到所有依赖
const pm = new PluginManager();
pm.registerPlugins([
  new Plugin1(),
  new Plugin2(),
  new Plugin3(),
]);
```

### 2. 便于测试
```typescript
// 单元测试示例
const pm = new PluginManager();
pm.registerPlugins([mockPlugin1, mockPlugin2]);

// 测试完成后可以轻松清理
pm.clear();
```

### 3. 配置灵活
```typescript
// 可以根据配置动态加载插件
const enabledPlugins = config.enabledPlugins || [];
const pluginInstances = enabledPlugins.map(name => createPlugin(name));
pm.registerPlugins(pluginInstances);
```

### 4. 向后兼容
- 保留了 `registerGlobalPlugin()` 函数（标记为废弃）
- 保留了 `registerAllGlobalPlugins()` 方法（标记为废弃）
- 现有代码不会立即报错

## 使用示例

### 新方式（推荐）
```typescript
import { PluginManager } from '../plugins/manager';
import { PansearchPlugin } from '../plugins/pansearch';
import { NyaaPlugin } from '../plugins/nyaa';

const pm = new PluginManager();
pm.registerPlugins([
  new PansearchPlugin(),
  new NyaaPlugin(),
]);

const plugins = pm.getPlugins(); // 按优先级排序
```

### 旧方式（已废弃）
```typescript
// 不再推荐使用
import { registerGlobalPlugin, PluginManager } from '../plugins/manager';
import { PansearchPlugin } from '../plugins/pansearch';

registerGlobalPlugin(new PansearchPlugin());

const pm = new PluginManager();
pm.registerAllGlobalPlugins(); // 显示警告
```

## 下一步建议

1. **移除废弃代码** - 在下一个大版本中完全移除 `registerGlobalPlugin` 和 `registerAllGlobalPlugins`
2. **配置驱动** - 从配置文件加载启用的插件列表
3. **插件工厂** - 实现插件工厂模式，支持插件的懒加载
4. **插件生命周期** - 添加插件的初始化、启动、关闭等生命周期方法
5. **插件依赖** - 支持插件间的依赖关系管理

## 总结

| 改进项 | 改进前 | 改进后 | 收益 |
|--------|--------|--------|------|
| 插件注册 | 全局注册表 | 依赖注入 | 明确依赖 |
| 可测试性 | 困难 | 简单 | 便于单元测试 |
| 配置灵活性 | 硬编码 | 配置驱动 | 动态加载 |
| 代码组织 | 分散注册 | 集中管理 | 更好维护 |
| 向后兼容 | - | 保留旧API | 平滑迁移 |

**总计：** 重构了23个插件文件，新增1个注册表文件，更新了2个核心文件，成功移除了全局注册表依赖。